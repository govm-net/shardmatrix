# ShardMatrix 网络分区测试计划

## 1. 测试目标

验证ShardMatrix网络层在网络分区情况下的行为和恢复机制：

1. 检测网络分区事件
2. 在分区期间保持各自子网的正常运行
3. 分区恢复后正确同步数据
4. 验证分叉处理和最长链选择机制

## 2. 测试环境

### 2.1 网络拓扑
```
正常网络:
Node A (127.0.0.1:9001) <-> Node B (127.0.0.1:9002) <-> Node C (127.0.0.1:9003)
     ^                                                    ^
     |                                                    |
     +------------------ 正常连接 -------------------------+

网络分区:
Group 1: Node A (127.0.0.1:9001)
Group 2: Node B (127.0.0.1:9002) <-> Node C (127.0.0.1:9003)
```

### 2.2 测试节点配置
- 3个验证者节点，形成DPoS共识
- 使用LevelDB持久化存储
- 启用libp2p网络层

## 3. 测试场景

### 3.1 场景1: 网络分区检测
**目标**: 验证节点能否检测到网络分区

**步骤**:
1. 启动3个节点并建立连接
2. 使用防火墙规则或网络工具模拟网络分区
3. 验证各节点能否检测到连接丢失
4. 验证节点状态更新

### 3.2 场景2: 分区内正常运行
**目标**: 验证在分区期间各子网能正常运行

**步骤**:
1. 网络分区发生
2. 各子网继续产生区块
3. 验证子网内共识正常工作
4. 验证数据一致性

### 3.3 场景3: 分区恢复和同步
**目标**: 验证分区恢复后节点能正确同步

**步骤**:
1. 恢复网络连接
2. 验证节点重新连接
3. 验证区块同步机制
4. 验证最长链选择和分叉处理

## 4. 测试指标

### 4.1 成功指标
- [ ] 节点能检测到网络连接状态变化
- [ ] 分区期间各子网能正常出块
- [ ] 分区恢复后能正确同步数据
- [ ] 最终所有节点达成一致状态
- [ ] 无数据丢失或损坏

### 4.2 性能指标
- 分区检测时间: < 30秒
- 重新连接时间: < 60秒
- 数据同步时间: < 2分钟（100个区块差异）

## 5. 实现方案

### 5.1 网络监控模块
在[node](file:///Volumes/ssd/myproject/shardmatrix/pkg/node/node.go#L31-L57)中添加网络状态监控功能:

1. 定期检查节点连接状态
2. 检测连接节点数量变化
3. 记录网络分区事件
4. 触发相应的处理逻辑

### 5.2 分区处理机制
1. 检测到网络分区时，节点进入"分区模式"
2. 在分区模式下，节点继续处理本地交易
3. 分区恢复后，触发区块同步流程
4. 使用最长链规则解决分叉

### 5.3 测试工具
1. 网络分区模拟工具
2. 节点状态监控工具
3. 数据一致性验证工具

## 6. 预期结果

### 6.1 正常情况
- 网络稳定时，3个节点正常同步
- 区块链高度保持一致
- 共识机制正常工作

### 6.2 分区期间
- Group 1 (Node A): 继续出块，但无法与其它节点通信
- Group 2 (Nodes B,C): 正常出块和同步
- 各组内区块链高度持续增长

### 6.3 分区恢复后
- 节点重新连接
- 触发区块同步
- 较短的链被较长的链替换
- 所有节点最终达成一致状态

## 7. 风险和缓解措施

### 7.1 风险
1. 分区期间产生大量分叉
2. 数据同步失败
3. 共识机制失效

### 7.2 缓解措施
1. 实现健壮的分叉处理机制
2. 添加重试机制和超时处理
3. 增强日志记录以便问题诊断

## 8. 测试验收标准

### 8.1 功能验收
- [ ] 网络分区检测准确率 100%
- [ ] 分区内正常出块成功率 100%
- [ ] 分区恢复后数据同步成功率 100%
- [ ] 最终状态一致性 100%

### 8.2 性能验收
- [ ] 分区检测时间 < 30秒
- [ ] 重新连接时间 < 60秒
- [ ] 数据同步时间 < 2分钟（100个区块差异）